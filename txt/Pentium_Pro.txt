Procesory, Pentium Pro
Pět a půl milionu tranzistorů se tísní na malé křemíkové destičce, která tvoří Pentium Pro. Způsob práce nového procesoru označuje Intel jako “Dynamic Execution”. Chip popisuje procesorovou techniku, která za tím vězí, poukazuje na silné a slabé stránky nástupce Pentia a měří jeho výkon.

Pentium Pro v bitech a bajtech
Pomocí veškerých dostupných triků Intel dokázal, že procesory 286, 386, 486 a Pentium byly vždy podstatně rychlejší než předchozí verze. Z procesoru Pentium dostanou vývojáři dalším zvýšením pracovního taktu ještě jednou trochu vyšší výkon, ale to bude všechno: se starou architekturou už není možné dokázat více.
S novým procesorem Pentium Pro začal Intel v mnohém od počátku. Vzhled procesoru (v jehož čtvercovém obalu jsou dva křemíkové čipy – tzv. “dies”) a zcela změněný design hlavních desek v počítačích nejmladší generace jsou pouze nejnápadnější znaky.
Rovněž to, že se v obvodech čipu nyní starají tři paralelní “pipelines” o rychlé zpracování příkazů, není vše. Skutečností je, že tento procesor programy zpracovává zcela jinak než všichni jeho předchůdci.
Zjednodušeně řečeno rozkládá procesor Pentium Pro všechny příkazy, které dostává, na malá sousta. Nezpracovává je postupně, ale pokouší se najít pořadí, ve kterém mohou být příkazy nejrychleji provedeny. Aby mohl takto pracovat, není nutný žádný nový software. Pentium Pro dokáže zacházet s dosavadní sadou příkazů procesorů Intel a díky tomu je kompatibilní se stávajícím softwarem.
Ovšem mnohé z triků, které měly o něco zvýšit výkonnost procesoru 486 a Pentia, dělají nyní potíže. To, co se u starších čipů staralo o rychlejší běh, způsobuje Pentiu Pro problémy. Malými sousty se dokonale zahltí, i když by je “dynamic execution” (dynamické provádění) vlastně mělo vykonávat jako na běžícím pásu. První počítače s procesorem Pentium Pro ukazují, jak daleko to může dojít: s aplikacemi pod Windows jsou dokonce pomalejší než srovnatelně vybavené PC s Pentiem (!).
Pentium Pro potřebuje především programy napsané pro 32 bitů. Ani operační systém nesmí brzdit: na počítači by měl být instalován správný 32bitový systém, jako jsou Windows NT. Jak rychle pak vše jede, ukázaly první testy Chipu. Při taktu procesoru 150 MHz jsou více než dvakrát rychlejší oproti stroji s procesorem Pentium 120 MHz.
Aby bylo možné tomuto zvýšení výkonu porozumět, je nutné zabývat se bity a bajty. Chip se vám pokusí vysvětlit práci Pentia Pro podrobněji.
Začněme s nejnápadnějším znakem, kterým je v procesorovém pouzdru integrovaná vyrovnávací paměť druhé úrovně Second Level Cache (L2 Cache). Slouží jako rychlá mezipaměť pro častěji potřebná data. Jako druhý čip doplňuje 5,5 milionu tranzistorů vlastního procesoru (téměř dvakrát víc než u Pentia) o dalších 15,5 milionu tranzistorů.
To platí pro 256KB variantu procesoru, která je nyní na trhu. Pro servery plánovaná 512KB verze ještě zdvojnásobí interní paměťovou kapacitu. Protože jsou struktury vyrovnávací paměti rovnoměrné, může být v křemíku realizována velmi hustě. Čip paměti cache je proto o něco menší než čip CPU.
Úlohou vyrovnávací paměti je zabránit zpožděním, která vznikají přístupem do operační paměti (RAM). Typické přístupové doby pro paměťové čipy se pohybují od 60 do 80 ns. Pro rychlý procesor je to však velmi pomalé.
Při taktu 150 MHz začíná každých 7 ns nový pracovní cyklus. Aby nemusel procesor vkládat příliš mnoho čekacích cyklů, ukládají se nejčastěji potřebné příkazy a data do vyrovnávací paměti, ke které může procesor přistupovat rychle. Od procesoru 486 je primární vyrovnávací paměť (L1 Cache) integrovaná v procesoru.
Prostorová blízkost k CPU (jádru procesoru) umožňuje Pentiu Pro, aby nyní mohla být mezi centrální jednotkou a L2 Cache s plnou rychlostí procesoru vyměňována i data. U prvního Pentia Pro je to 150 MHz.
CPU a L2 Cache komunikují přes 64bitové rozhraní. Mimoto je tato vyrovnávací paměť uspořádána tak, že neblokuje procesor. Ten není akcemi vyrovnávací paměti ani zastavován, ani nemůže dojít ke zpoždění transakcí na procesorové sběrnici.
Pokud například nejsou vyžádaná data ve vyrovnávací paměti nalezena, a dojde tedy ke stavu “miss”, provede procesor okamžitě jiné instrukce. Zároveň proběhne pokus obstarat data chybějící v této paměti přes paměťovou sběrnici, rovněž 64bitovou. Procesor je naproti tomu čistým 32bitovým procesorem. Už započaté instrukce mohou způsobit další “cache-miss” a vyvolat další akce na sběrnici. Pentium Pro zvládne až čtyři takto rozpracované transakce najednou.
U “čtyřiosmšestek” a pentiových počítačů je běžné umístit L2 Cache ve formě zvláštního prvku na hlavní desku. Že v procesorovém pouzdře integrovaná mezipaměť nejen šetří místo, ale je i podstatně rychlejší, dokazuje jednoduchý test Chipu. Pracovalo se zde s rozdílně velkými datovými bloky, aby se postupně 16 KB velká primární vyrovnávací paměť (L1 Cache) v CPU stejně jako L2 Cache a nakonec i operační paměť (RAM) zapojily do práce.
S jednoduchými nízkoúrovňovými rutinami se ukazuje, že výměna dat s L1 Cache v Pentiu Pro probíhá o něco rychleji než u Pentia. Pokud jsou testovací soubory veliké 1 MB, nemohou být udržovány v 256KB vyrovnávací paměti a rychlost u obou systémů se sníží stejnou měrou. Zajímavá oblast je však mezi tím. Zde dokáže Pentium Pro přistupovat k mezipaměti rychleji než staré Pentium. Testovali jsme to na počítači s Pentiem Pro od Siemens Nixdorf (150 MHz) - viz graf.
“Dynamic Execution” je pojem, který razí Intel. Skrývá se za ním kombinace tří technik použitých v procesoru Pentium Pro za účelem urychlení běhu programů. Jsou to:
ä Předpověď skoků: procesor se dívá několik kroků v programu dopředu a určuje, které skoky s velkou pravděpodobností nastanou a které skupiny instrukcí proto budou zřejmě zpracovávány jako příští.
ä Analýza toku dat: v dalším kroku zkoumá procesor, jaké instrukce jsou závislé na jiných výsledcích a datech. Tím sestavuje optimální časový plán pro zpracovávání jednotlivých příkazů. Původní pořadí příkazů přitom nemusí být dodrženo: nastupuje “Out-of-Order Execution”. Díky tomu je možné obejít některé případy, které si v Pentiu vynucují pauzy, protože se postupuje pouze krok za krokem.
ä Spekulativní provádění: na základě časového plánu se provádějí “potenciální” příkazy a procesor je díky tomu stále smysluplně zaměstnán.
Pro uskutečnění Dynamic Execution musel Intel najít nová řešení, protože jinak by nebylo možné překonat výkony Pentia. Pipeline Pentia se skládá z pěti stupňů, Pentium Pro jich má 14. Intel zde sáhl hluboko do kouzelného klobouku RISC (Reduced Instruction Set Computer). Zatímco Pentium dokáže zpracovat dvě instrukce v každém taktu (a je tak prvním superskalárním procesorem firmy Intel); Pentium Pro zvládá na jeden takt ve třech paralelních linkách až tři instrukce.
“Superpipelined” je jiným kouzelným slovem moderní procesorové technologie. Označuje zpracovávání ještě více příkazů na ještě menších úsecích. Práci pipeline je možné si představit jako běžící pás. Díky tomu může mít Pentium Pro vyšší frekvence taktu.
Lineární zpracování vstupujících instrukcí s klasickými fázemi “fetch” a “execute” nahražuje u Pentia Pro tzv. instruction pool. Zde procesor sestavuje plán pro zpracovávání příkazů. V něm by mohly být například čtyři příkazy, z nichž první nemůže být okamžitě proveden, protože potřebná data se nenacházejí ve vyrovnávací paměti a musejí být nejdříve vyzvednuta z operační paměti. Pokud druhá instrukce závisí na první, musí tradiční CPU nejprve počkat – Pentium Pro naproti tomu může dopředu spekulativně provádět třetí a čtvrtý příkaz, pokud k nim nepotřebuje předchozí výsledky. Výsledky se vracejí zpět do instruction pool a tam čekají na další zpracování ve správném pořadí.
“Cache-miss” potřebuje mnoho interních taktů. Pentium Pro v této době prohledává 20 až 30 instrukcí před programovým čítačem. Mezi nimi se nachází průměrně pět větvení, která je třeba správně předpovědět, abychom výhody v rychlosti zase neztratili. Nevýhodou superskalární koncepce je, že špatné předpovědi způsobí enormní časové ztráty. Všechny už započaté instrukce pak třeba musí být stornovány.
Připojené blokové schéma vysvětluje způsob práce nového procesoru. Začátek je v Instruction Fetch Unit (IFU), která obsahuje tzv. I-Cache. Z této paměti si v případě potřeby CPU odebírá rychle své instrukce. Kde je třeba obstarat potřebné informace, sdělí IFU Branch Target Buffer (BTB), jehož úlohou je předpovídat větvení. Používá k tomu relativně komplikované algoritmy a dosahuje úspěšnosti přes 90 %.
I-Cache vybírá vždy řádku vyrovnávací paměti a předává tak dekodéru 16 bajtů, které jsou “aligned”, tedy zarovnány na hranice slov. Protože programový kód v instrukcích architektury Intel se často rozvětvuje uprostřed nebo na konci řádky vyrovnávací paměti, jsou načítány vždy řádky dvě.
Úkolem dekodéru instrukcí (Instruction Decoder - ID) je rozdělit instrukce pro další zpracování na malá “sousta”, tzv. micro-ops. Tyto mikrooperace představují jakési atomární jednotky práce v procesoru Pentium Pro. Všechny mikrooperace jsou stejně dlouhé a skládají se vždy ze dvou logických zdrojů a jednoho logického cíle. Většina instrukcí se rozkládá přímo do jednotlivých mikroinstrukcí, některé instrukce se do mikroinstrukcí konvertují v poměru 1:4.
Komplexní instrukce vyžadují svůj vlastní mikrokód (MIS = mikrokód instrukční sekvence). Tento mikrokód je ovšem pouze sadou programovaných sekvencí normálních mikrooperací. V každém taktovém cyklu tři separátní dekodéry (D0, D1, D2) generují tři mikroinstrukce, proto se Pentium Pro označuje také jako superskalární procesor třetího stupně. Podobné techniky jako Intel se svými mikroinstrukcemi používá i AMD v procesoru K5 a firma Nexgen u Nx586.
Mikroinstrukce jsou předávány do Register Alias Table (RAT), kde se logické registrové reference převádějí na fyzické registrové reference Pentia Pro. Architektura Intelu má k dispozici relativně malou sadu registrů. To omezuje výkonnost při zpracování instrukcí “mimo pořadí” (out-of-order); v tomto případě totiž dochází ke zbytečným čekacím cyklům, než může být nějaký registr znovu použit.
K mikrooperacím se ještě připojí stavová informace, načež se uloží do Reorder Buffer (ROB), který představuje instruction pool. Zde jsou seřazeny tak, že na konci provádění příkazů může být opět vytvořeno takové pořadí, aby souhlasila sémantika programu.
Z RAT se kromě toho mikrooperace dostávají do Reservation Station (RS), odkud se posílají prováděcím jednotkám (EU = Execution Units) procesoru. Předpokladem ovšem je, že stav signalizuje, že mikrooperace má všechny své operandy a že pro mikrooperaci příslušná EU má k dispozici zdroje.
EU přistupují k Reservation Station přes pět rozhraní. Na port 0 jsou připojeny především nejrůznější jednotky pohyblivé čárky. Jsou tam koncentrovány, protože jako společný znak potřebují širší datovou cestu (jedna hodnota s pohyblivou čárkou potřebuje 86 bitů). Port 1 je tvořen jednotkou pevné čárky a skokovou jednotkou. Porty 2, 3 a 4 slouží pro přístup do paměti. Výsledek provádění se dostane jak do RS, tak do ROB. Tím je zajištěno, že následné operace mohou přistupovat k aktuálním datům.
Špičkové rychlosti dosahuje Pentium Pro při zpracování pěti mikrooperací na takt, to znamená vždy jedné mikrooperace na každém portu. Průměr jsou tři mikroinstrukce na takt. Mikrooperace se dále předávají podle požadavků toku dat a podle toho, jak jsou k dispozici z prováděcích jednotek – tedy nezávisle na původním pořadí v programu.
Nakonec “jednotka zpětného výběru” (retire unit) kontroluje stav mikrooperace v instruction pool. Hledá už provedené mikrooperace, které lze odstranit z poolu. Po jejich odebrání je jako u původních instrukcí intelské architektury zapisován originální cíl. Poté retire unit obnoví původní programové pořadí. Totéž musí udělat v případě výskytu přerušení, “traps”, “faults”, “breakpoints” a špatných předpovědí.
Většina toho, co se v určitém časovém okamžiku v Pentiu Pro děje, je čistá spekulace. Teprve na samém konci je možné spekulativně vytvořená data převzít do Retirement File Register (RFR). Jeho jednotka může převzít za takt až tři mikrooperace.
Vstupy a výstupy nevypadají u Pentia Pro v principu jinak než u 486. Že nový procesor interně pracuje zcela jinak, o to se nemusí uživatel starat. Může procesor prostě považovat za černou skříňku. Pochybnosti vzniknou, teprve když mistrovské technické dílo obdrží nevhodný software a zůstane tak daleko za očekáváním.
Schopnost Out-of-Order Execution, která dává procesoru stále práci, je klíčem k rychlosti Pentia Pro. V některých případech se ale zpracovat příkazy mimo pořadí nepodaří. Takové instrukce potom donutí superpipeline “koktat”. Procesor musí všechny ostatní operace zastavit a za určitých okolností začít znovu, aby mohl nejdříve zpracovat speciální příkaz.
Například přečtení kompletního registru může zastavit zpracování příkazů, pokud odpovídající příkaz následuje bezprostředně za zápisovou instrukcí pro segment tohoto registru. Přesně to je častý případ, kdy se nejdříve zapisuje 8 bitů 16bitového registru. Programátoři v assembleru dosud pro ukládání jednobajtových hodnot používali parciální registry jako AL atd. Fatální je, pokud v programu přímo následuje příkaz přečtení AX, 16bitového supersetu registru AL. Tyto programovací metody pocházejí ještě z dob 286 a DOS, kde byl adresový prostor jen 64 KB.
Takovéto parciální registry se sice v 16bitovém programovém kódu nevyskytují příliš často, ale pokud k tomu dojde, způsobí podstatné zpoždění. Procesor se pak může dostat na sedm i více cyklů do čekacího stavu. Během této doby už by jinak mohl provést třeba dalších 20 příkazů.
Kompilátory jsou principiálně schopné tento problém minimalizovat, často jsou ale parciálně využívané registry v kódu assembleru. Windows 3.1 a rovněž části Windows 95 obsahují takto ručně psaný strojový kód. Proto ani 32bitová aplikace pod Windows 95 nedokáže Pentium Pro zcela využít. Čtení celých registrů po zápisových operacích pro 8bitové nebo 16bitové registry mohou sice v 32bitovém kódu způsobit stejné problémy, jsou ovšem mnohem vzácnější. Intel optimalizoval Pentium Pro pro 32bitový software.
V 16bitových programech mohou způsobit problémy i I/O příkazy a operace v řídicích registrech. Ani je nemůže Pentium Pro zpracovávat v poolu v libovolném pořadí. Pokud procesor narazí na takové instrukce, musí uzavřít všechny ještě nezpracované příkazy a nemůže zatím začít s dalším. Jinak řečeno, pipeline se vyprázdní.
U 32bitového softwaru je správa paměti většinou méně intenzívní než u 16bitového programu, protože jako adresový prostor může být využito až 4 GB paměti. Hlavní procesor se tím uvolní a může se koncentrovat na vlastní výpočetní operace. Při srovnání sady aplikací Windows 3.1 (16 bitů) s 32bitovými aplikacemi pod Windows 95 zjistíme, že podíl příkazů na správu paměti poklesl. Díky tomu je možné provést za stejnou dobu více početních operací (viz diagram).
Jako nejvhodnější operační systémy pro Pentium Pro vidí Intel v roce 1996 Windows NT a Unix. Pokud by se mělo pracovat s Windows 3.1 nebo 95, je stále jako dřív doporučen procesor Pentium. Teprve v roce 1997 je v plánu Windows 95 pro Pentium Pro. Do té doby by měly být k dispozici rychlejší procesory Pentium Pro a dostatek 32bitových aplikací.
Nový procesor přináší i nový design  počítačové sběrnice. Pentium Pro Bus nabízí možnost přímo připojit další procesory nebo High-Speed-I/O. Procesorová sběrnice nesmí být zaměňována se sběrnicí PCI (je připojena na procesorovou rychlým rozhraním – PCI Bridge).
Asi 150 nožiček procesoru spojuje datová vedení, která je možné zhruba rozdělit na typy request a response. Request (vyžádání dat) potřebuje dva taktové cykly. V prvním se řeší adresa, typ paměti apod. V druhém přichází speciální rozlišení a řídicí příkaz.
Různé žádosti a odpovědi mohou být na sběrnici současně. Procesor může do paměti poslat více žádostí, aniž by vždycky musel čekat na odpověď. Až je požadovaná informace nalezena, pošle paměť request do procesoru. I když na sebe nechá odpověď déle čekat, nejsou tím transakce na sběrnici brzděny.
Bez jakýchkoli přídavných logických prvků je v multiprocesorovém stroji možné připojit čtyři procesory Pentium Pro přímo na procesorovou sběrnici. Každý procesor má interně potřebnou logiku, aby byla zajištěna koherence dat. Další skupiny procesorů je možné připojit na procesorovou sběrnici přes tzv Cluster-Bridge.
Aby současně umožnil různé přístupy na sběrnici, aniž by vznikaly elektrické problémy, rozloučil se Intel s tradiční TTL (Transistor Transistor Logic), která v PC sloužila v minulých letech. Pentium Pro namísto toho používá logiku GTL+ (Gunning Transceiver Logic), rozšířenou dosud jenom u velkých počítačů. GTL+ vystačí s menším napěťovým odstupem mezi různými logickými stavy, což umožňuje snáze operovat při vyšších  frekvencích.
Už na výstavě Systems v Mnichově bylo možné vidět počítače s Pentiem Pro před jeho oficiálním představením 1. listopadu. Vystavené přístroje byly ovšem ručně sestavené prototypy, které se v této podobě sotva dostanou do prodeje.
Například Compaq a Peacock představovaly počítače s taktem pouhých 133 MHz. Intel nebude ovšem procesory s touto specifikací dodávat: protože je výroba čipů velmi přesná, začne hned s frekvencí 150 MHz. V počítači Peacock byla hlavní deska od výrobce Asus, který bude zastoupen v obchodě s Pentiem Pro hned od začátku (u nás se s těmito deskami setkáte u firem Autocont nebo Tesco).
Jiné to bylo u IBM a Siemens Nixdorf. Tito dva velikáni se vlastním vývojem odchýlili od doporučení Intelu, aby z Pentia Pro dostali ještě více. Oba výrobci dali Chipu k dispozici vyspělé 150MHz přístroje, jejichž rychlost dělala velký dojem.
Chip počítače testoval s 32bitovými verzemi programů Word a Excel pod Windows NT. Srovnání výsledků vidíte v diagramu. Jak IBM, tak Siemens Nixdorf jsou více než dvakrát rychlejší než Pentium 120, který byl Chipem použit pro srovnání. V PC 360 Pentium Pro má firma IBM vestavěnu hlavní desku firmy Intel. Vlastním BIOS si ale inženýři otevřeli dveře pro systémová zlepšení. Pomocí řady parametrů je možné optimalizovat správu paměti. Počítač s 1,2GB pevným diskem a grafickou kartou Matrox Millennium si ovšem IBM cení na 4000 až 5000 USD (bez monitoru).
Millennium v současné době favorizují ve svých “high-end-PC” i různí další výrobci, mezi nimi také Siemens Nixdorf. Ten navíc zvyšuje rychlost Pentia Pro pomocí paměti. Sada čipů Orion nabízí se svými více než 100 konfiguračními registry dostatek možností pro zrychlení přístupu k datům pomocí vhodně zvoleného časování.
Protože sada Orion nepodporuje EDO-RAM, používá SNI ve Scenic 6T tzv. memory-interleaving. Základní desku si navrhli v Augsburgu sami.
Testovali jsme stroj se 64 MB. Při vypnutí ukládá Scenic 6T automaticky práci na pevný disk, v režimu remote může být probuzen přes modem. Solidně postavený počítač má se 16 MB operační paměti, 1,6GB diskem a grafickou kartou osazenou 2 MB stát asi 7800 DEM.
Manfred Flohr

Pipeline: provádění instrukcí jako na běžícím pásu
Způsob práce procesorů je jasný při prvním pohledu na schematický diagram činnosti pipeline (česky snad nejlépe “linka”),  který ilustruje “pásové” zacházení s mikrooperacemi v Pentiu Pro. V pipeline tohoto procesoru můžeme rozlišit 14 stupňů zpracování.
Pipeline se skládá ze tří oddělených částí, které jsou na sobě více méně nezávislé. 14stupňová linka jako jediný celek by měla nevýhodu: nebyla by rychlejší než její nejpomalejší stupeň.
Díky dalšímu rozdělení původně pětistupňové pipeline procesoru 486 a Pentia nyní každý stupeň vykonává méně práce. Výsledkem je, že stupně pipeline (“stanice pásu”) mohou být absolvovány rychleji. Proto jsou možné i vyšší taktovací frekvence.
Ř První část pipeline v Pentiu Pro se skládá s osmi taktových cyklů a Intel ji označuje jako In-Order Front End.Instruction Pointer (IP) na začátku je z blokového schématu známý Branch Target Buffer, který hledá další příkaz v zásobníku příkazů (I-Cache). V následujících dvou a půl taktových cyklech se přistupuje na I-Cache, další dva a půl taktu stojí dekódování, při kterém se rovněž generují mikrooperace. 
Následuje tzv. přejmenování registru, a v posledním stupni dojde na zápis do Reservation Station, který se většinou překrývá s minimálně jedním stupněm v následujícím segmentu linky.
Pokud se v 16bitovém programu objeví příkazy, které Pentium Pro nemůže zpracovat “out-of-order” (mimo pořadí), musí být rozpracované operace v těchto nižších stupních linky za určitých okolností zrušeny a v takovém případě je nutné začít znovu.
Ř Začátek druhého oddílu Out-of-Order Core odpovídá vstupu do Reorder Buffer (ROB). Dva stupně jsou zde vyhraženy pro identifikaci mikrooperací a jeden pro provedení operace. Operace s pohyblivou čárkou trvají déle.
Ř V poslední části pipeline označované jako retirement se mimo jiné zajišťuje, aby mikrooperace na konci zase daly jeden celek.
